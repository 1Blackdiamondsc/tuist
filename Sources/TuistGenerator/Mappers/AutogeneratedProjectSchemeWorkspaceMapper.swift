import Foundation
import TuistCore

public final class AutogeneratedProjectSchemeWorkspaceMapper: WorkspaceMapping {
    public init() {}
    
    public func map(workspace: Workspace, graph: Graph) throws -> (Workspace, [SideEffectDescriptor]) {
        guard let project = graph.entryNodes
            .compactMap ({ $0 as? TargetNode })
            .first?
            .project
        else { return (workspace, []) }
        
        var workspace = workspace
        
        let targetNodes = graph.targets.values.flatMap { $0 }
        let targets = targetNodes
            .filter { !$0.target.product.testsBundle }
            .map { TargetReference(projectPath: $0.project.path, name: $0.name) }
        let testableTargets = targetNodes
            .filter(\.target.product.testsBundle)
            .map { TargetReference(projectPath: $0.project.path, name: $0.name) }
            .map { TestableTarget(target: $0) }
        
        let scheme = Scheme(
            name: "\(workspace.name)-Project",
            buildAction: BuildAction(targets: targets),
            testAction: TestAction(
                targets: testableTargets,
                arguments: nil,
                configurationName: project.defaultDebugBuildConfigurationName,
                coverage: false,
                codeCoverageTargets: [],
                preActions: [],
                postActions: [],
                diagnosticsOptions: Set()
            )
        )
        
        workspace.schemes.append(scheme)
        
        return (workspace, [])
    }
}

